"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[679],{31:function(t,e,n){n.d(e,{Dj:function(){return h},G$:function(){return o},KC:function(){return m},SX:function(){return s},bm:function(){return c},hD:function(){return a},lG:function(){return f},p3:function(){return u},s1:function(){return i},tE:function(){return d}});var r,l=n(257);let i="2009034946-GQ1UQIRr".trim()||"2009034946-GQ1UQIRr",u=(null===(r=l.env.NEXT_PUBLIC_LIFF_ID_ADMIN_DIRECT)||void 0===r?void 0:r.trim())||"2009034946-LkF5LngF",o="https://liff.line.me/2009034946-LkF5LngF",a="2009034946-KaRhKY16".trim()||"2009034946-KaRhKY16",c="https://marche-link.jp/admin-entry/",s="https://marche-link.jp/admin/",d="marche-link-liff-inited",f="https://liff.line.me/".concat(i,"/"),m="https://liff.line.me/".concat(u,"/"),h="https://liff.line.me/".concat(a)},6679:function(t,e,n){n.d(e,{Be:function(){return E},EO:function(){return f},Rf:function(){return m},dD:function(){return b},fX:function(){return y}});var r=n(7437),l=n(2265),i=n(5978),u=n(6942),o=n(7293),a=n(5173);let c="marche-link-admin-storeIds-",s="marche-link-admin-lastSession",d="marche-link-admin-theme-",f="marche-link-admin-theme-updated",m="marche-link-new-order-notification-updated";function h(t,e){try{localStorage.setItem(s,JSON.stringify({uid:t,storeIds:e}))}catch(t){}}function y(t){try{let e=localStorage.getItem(c+t);if(!e)return null;let n=JSON.parse(e);if(!Array.isArray(n)||!n.every(t=>"string"==typeof t))return null;return n}catch(t){return null}}function g(t,e){try{localStorage.setItem(c+t,JSON.stringify(e)),e.length>=1&&h(t,e)}catch(t){}}function p(t){try{let e=localStorage.getItem(d+t);if(!e)return null;let n=JSON.parse(e);if(!n||"object"!=typeof n)return null;let r=n.buttonColor;if("string"!=typeof r||!r.trim())return null;let l=n.primaryColor;return{buttonColor:r.trim(),primaryColor:"string"==typeof l&&l.trim()?l.trim():void 0}}catch(t){return null}}function v(t,e){try{localStorage.setItem(d+t,JSON.stringify({buttonColor:e.buttonColor,primaryColor:e.primaryColor}))}catch(t){}}let w=(0,l.createContext)(null),I=[0,400,1e3,2500];function E(t){let{children:e}=t,{user:n,loading:c}=(0,u.a)(),[d,E]=(0,l.useState)([]),[b,S]=(0,l.useState)(""),[T,L]=(0,l.useState)(null),[C,N]=(0,l.useState)(!0),[k,A]=(0,l.useState)(!0),[F,D]=(0,l.useState)(!0),[J,R]=(0,l.useState)(null),[j,O]=(0,l.useState)(0),U=(0,l.useRef)(null),_=(0,l.useRef)(null),P=(0,l.useRef)(!1);(0,l.useEffect)(()=>{let t=function(){try{let t=localStorage.getItem(s);if(!t)return null;let e=JSON.parse(t);if(!e||"object"!=typeof e||"string"!=typeof e.uid)return null;let n=e.storeIds;if(!Array.isArray(n)||!n.every(t=>"string"==typeof t)||0===n.length)return null;return{uid:e.uid,storeIds:n}}catch(t){return null}}();if(R(t),t&&Array.isArray(t.storeIds)&&t.storeIds.length>=1){var e;E(t.storeIds),L(null!==(e=p(t.storeIds[0]))&&void 0!==e?e:null),D(!1)}},[]),(0,l.useEffect)(()=>{var t,e,r,l;if(c){let e=J&&J.storeIds.length>=1;if(e){let e=J.storeIds;E(e),L(null!==(t=p(e[0]))&&void 0!==t?t:null),D(!1)}let n=setTimeout(()=>{e||(E([]),D(!1))},6e3);return()=>clearTimeout(n)}if(!(null==n?void 0:n.uid)){E([]),D(!1),U.current=null;return}if(U.current===n.uid&&0===j){if(J&&J.uid===n.uid&&J.storeIds.length>=1){let t=J.storeIds;E(t),L(null!==(e=p(t[0]))&&void 0!==e?e:null)}D(!1);return}let u=y(n.uid),s=J&&J.uid===n.uid&&J.storeIds.length>=1;if(null!==u&&u.length>=1)E(u),L(null!==(r=p(u[0]))&&void 0!==r?r:null),D(!1);else if(s){let t=J.storeIds;E(t),L(null!==(l=p(t[0]))&&void 0!==l?l:null),D(!1)}else D(!0);U.current=n.uid;let d=!1,f=setTimeout(()=>{var t,e;if(d)return;let r=null!=u?u:(null==J?void 0:J.uid)===n.uid?J.storeIds:null;null!==r&&r.length>=1?(E(r),L(null!==(e=p(r[0]))&&void 0!==e?e:null)):(u&&u.length>=1&&(0,a.dr)(u),(null==J?void 0:J.uid)===n.uid&&J.storeIds.length>=1&&(0,a.dr)(J.storeIds),h(n.uid,[]),E([]),L(null)),D(!1),null===(t=_.current)||void 0===t||t.call(_),_.current=null},15e3),m=()=>{try{return(0,o.T)()}catch(t){return null}},v=null,w=(t,e)=>{let r=m();if(!r){let r=e+1;if(r<I.length)v=setTimeout(()=>{d||w(t,r)},1===r?400:2===r?600:1500);else if(!d){clearTimeout(f);let t=null!=u?u:(null==J?void 0:J.uid)===n.uid?J.storeIds:null;if(null!==t&&t.length>=1){var l;E(t),L(null!==(l=p(t[0]))&&void 0!==l?l:null)}else u&&u.length>=1&&(0,a.dr)(u),(null==J?void 0:J.uid)===n.uid&&J.storeIds.length>=1&&(0,a.dr)(J.storeIds),h(n.uid,[]),E([]),L(null);D(!1)}return}let o=(0,i.JU)(r,"adminUsers",n.uid);return(P.current?()=>(P.current=!1,(0,i.Xk)(o)):()=>(0,i.QT)(o))().then(t=>{var e,r;if(d)return;clearTimeout(f);let l=t.exists()?t.data():null,i=l&&Array.isArray(l.storeIds)?l.storeIds:[],o=!l||"boolean"!=typeof l.premium||l.premium;if(0===i.length){let t=null!=u?u:(null==J?void 0:J.uid)===n.uid?J.storeIds:null;t&&t.length>=1&&(0,a.dr)(t),h(n.uid,[])}E(i),N(o),i.length>=1?L(null!==(r=p(i[0]))&&void 0!==r?r:null):L(null),g(n.uid,i),D(!1),null===(e=_.current)||void 0===e||e.call(_),_.current=null}).catch(e=>{var r,l;if(d)return;clearTimeout(f);let i=(null==e?void 0:e.message)&&String(e.message).toUpperCase().includes("INTERNAL")||(null==e?void 0:e.code)==="internal";if(0===t){setTimeout(()=>w(1,0),400);return}if(1===t){setTimeout(()=>w(2,0),2e3);return}if(2===t&&i){setTimeout(()=>w(3,0),5e3);return}let o=null!=u?u:(null==J?void 0:J.uid)===n.uid?J.storeIds:null;null!==o&&o.length>=1?(E(o),L(null!==(l=p(o[0]))&&void 0!==l?l:null)):(u&&u.length>=1&&(0,a.dr)(u),(null==J?void 0:J.uid)===n.uid&&J.storeIds.length>=1&&(0,a.dr)(J.storeIds),h(n.uid,[]),E([]),L(null)),D(!1),null===(r=_.current)||void 0===r||r.call(_),_.current=null}),()=>{}},b=setTimeout(()=>{d||w(0,0)},500);return()=>{d=!0,clearTimeout(f),clearTimeout(b),v&&clearTimeout(v)}},[null==n?void 0:n.uid,c,j,J]),(0,l.useEffect)(()=>{let t;if(!(null==n?void 0:n.uid))return;try{t=(0,o.T)()}catch(t){return}if(!t)return;let e=()=>{try{(0,i.QT)((0,i.JU)(t,"adminUsers",n.uid)).then(t=>{let e=t.exists()?t.data():null,r=e&&Array.isArray(e.storeIds)?e.storeIds:[],l=!e||"boolean"!=typeof e.premium||e.premium;E(r),N(l),g(n.uid,r)}).catch(()=>{})}catch(t){}},r=()=>{"visible"===document.visibilityState&&e()},l=()=>e(),u=t=>{(t.persisted||"visible"===document.visibilityState)&&e()};"undefined"!=typeof document&&(document.addEventListener("visibilitychange",r),window.addEventListener("focus",l),window.addEventListener("pageshow",u));let a=setTimeout(e,1200);return()=>{"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",r),window.removeEventListener("focus",l),window.removeEventListener("pageshow",u)),clearTimeout(a)}},[null==n?void 0:n.uid]);let K=(0,l.useCallback)((t,e)=>{e&&(P.current=!0),_.current=null!=t?t:null,D(!0),O(t=>t+1)},[]);(0,l.useEffect)(()=>{let t=d[0];S(t?(0,a.eg)(t):"")},[d]),(0,l.useEffect)(()=>{let t=d[0];if(!t){L(null);return}let e=p(t);e&&L(e);let n=!1;try{let r=(0,o.T)();if(!r){e||L(null);return}(0,i.QT)((0,i.JU)(r,"stores",t)).then(e=>{if(n)return;let r=e.exists()?e.data():null,l=(null==r?void 0:r.theme)&&"object"==typeof r.theme?r.theme:null,i=l&&"string"==typeof l.buttonColor?l.buttonColor.trim():null,u=l&&"string"==typeof l.primaryColor?l.primaryColor.trim():null;if(i){let e={buttonColor:i,primaryColor:u||void 0};v(t,e),L(e)}else L(null);A((null==r?void 0:r.newOrderNotificationEnabled)!==!1)}).catch(()=>{n||e||L(null)})}catch(t){e||L(null)}return()=>{n=!0}},[d]),(0,l.useEffect)(()=>{let t=()=>{let t=d[0];S(t?(0,a.eg)(t):"")};return window.addEventListener(a.Ro,t),()=>window.removeEventListener(a.Ro,t)},[d]),(0,l.useEffect)(()=>{let t=t=>{let e=t.detail;"boolean"==typeof(null==e?void 0:e.enabled)&&A(e.enabled)};return window.addEventListener(m,t),()=>window.removeEventListener(m,t)},[]),(0,l.useEffect)(()=>{let t=d[0];if(!t)return;let e=()=>{let e=(0,o.T)();e&&(0,i.QT)((0,i.JU)(e,"stores",t)).then(e=>{if(!e.exists())return;let n=e.data(),r=(null==n?void 0:n.theme)&&"object"==typeof n.theme?n.theme:null,l=r&&"string"==typeof r.buttonColor?r.buttonColor.trim():null,i=r&&"string"==typeof r.primaryColor?r.primaryColor.trim():null;if(l){let e={buttonColor:l,primaryColor:i||void 0};v(t,e),L(e)}}).catch(()=>{})};return window.addEventListener(f,e),()=>window.removeEventListener(f,e)},[d]);let x=(0,l.useMemo)(()=>({storeIds:d,storeName:b,theme:T,premium:C,newOrderNotificationEnabled:k,loading:F,refetch:K}),[d,b,T,C,k,F,K]);return(0,r.jsx)(w.Provider,{value:x,children:e})}function b(){let t=(0,l.useContext)(w);return null===t?{storeIds:[],storeName:"",theme:null,premium:!0,newOrderNotificationEnabled:!0,loading:!0,refetch:()=>{}}:t}},7293:function(t,e,n){n.d(e,{E7:function(){return m},G5:function(){return f},T:function(){return h},V1:function(){return u.V1},lx:function(){return y}});var r=n(738),l=n(3301),i=n(5978),u=n(3491);let o={apiKey:"AIzaSyCa4s0nrtJe2PNf86c3843MVDsL6fpwljQ",authDomain:"marche-link.firebaseapp.com",projectId:"marche-link",storageBucket:"marche-link.firebasestorage.app",messagingSenderId:"1006467595458",appId:"1:1006467595458:web:ecf555e02bb7335e5dcf5b"},a=null,c=null,s=null,d=!1;function f(){if(!o.apiKey||!o.projectId)return null;if(a)return a;if(d)return null;try{let t=(0,r.C6)();return a=t.length>0?t[0]:(0,r.ZF)(o)}catch(t){return d=!0,"undefined"!=typeof console&&console.warn&&console.warn("[Firebase] 初期化に失敗しました",t),null}}function m(){try{let t=f();if(!t)return null;return c||(c=(0,l.v0)(t)),c}catch(t){return null}}function h(){try{let t=f();if(!t)return null;return s||(s=(0,i.ad)(t)),s}catch(t){return null}}function y(t){try{let e=f();if(!e)return null;return(0,u.$C)(e,null!=t?t:"asia-northeast1")}catch(t){return null}}},6942:function(t,e,n){n.d(e,{a:function(){return c}});var r=n(2265),l=n(3301),i=n(7293),u=n(6515),o=n(31),a=n(8045);function c(){let[t,e]=(0,r.useState)(null),[n,c]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{let t;try{let n=(0,i.E7)();if(!n){c(!1);return}t=(0,l.Aj)(n,t=>{e(null!=t?t:null),c(!1)})}catch(t){e(null),c(!1)}return()=>{try{null==t||t()}catch(t){}}},[]),{user:t,loading:n,signInWithLine:async()=>{let t;let e="1"===new URLSearchParams(window.location.search).get("line_debug"),n=t=>{e&&"undefined"!=typeof alert&&alert(t)},r=(0,i.E7)();if(!r)throw Error("Firebase Auth が利用できません");try{await (0,u.$w)(o.p3)}catch(t){throw Error("LINE でログインしてください。LINE アプリ内で、管理画面の LIFF リンクから開き直すか、もう一度お試しください。")}let c=null;for(let t of[0,200,500,1e3])if(t>0&&await new Promise(e=>setTimeout(e,t)),c=await (0,u.Tc)())break;if(!c){if((0,u.DT)()){(0,u.Lq)(o.SX);return}throw Error("このページは LINE アプリ内で開く必要があります。リンクを LINE のトークに送り、そのリンクをタップして開いてください。")}n("1/4 LIFF IDトークン取得済み");let s=(0,i.lx)("asia-northeast1");if(!s)throw Error("Cloud Functions が利用できません");let d=(0,i.V1)(s,"getLineAuthCustomToken");try{t=await Promise.race([d({idToken:c}),new Promise((t,e)=>setTimeout(()=>e(Error("認証サーバーからの応答がありません。通信を確認して再試行してください。Cloud Functions のデプロイと LINE_CHANNEL_ID の設定を確認してください（docs/auth-server-no-response.md）。")),2e4))])}catch(t){throw n("2/4 失敗: "+(t instanceof Error?t.message:String(t))),t}n("2/4 カスタムトークン受信済み");let{customToken:f}=t.data;if(!f)throw n("3/4 失敗: customToken が空"),Error("認証に失敗しました");try{n("3/4 Firebase にサインイン中..."),await (0,l._p)(r,f)}catch(e){let t=e instanceof Error?e.message:String(e);if(n("3/4 失敗: "+t),t.includes("auth/api-key-not-valid"))throw Error("Firebase の API キーが無効です。LINE 内で開いている場合は、Google Cloud Console の API キー「HTTP リファラ」制限で LINE 由来のリクエストを許可するか、制限を「なし」にしてください。詳しくは docs/firebase-api-key-iphone.md");throw Error(t.includes("auth/")?"Firebase へのログインに失敗しました。再試行してください。":t)}n("4/4 ログイン完了"),(0,a.rZ)()},signOut:async()=>{let t=(0,i.E7)();t&&await (0,l.w7)(t)}}}},6515:function(t,e,n){n.d(e,{$w:function(){return a},DT:function(){return c},Lq:function(){return d},Tc:function(){return m},cz:function(){return h},jl:function(){return s},lA:function(){return y},o$:function(){return f}});let r=null,l=null,i=!1,u=!1;async function o(){if(r)return r;try{return r=(await n.e(949).then(n.bind(n,2949))).default}catch(t){return null}}async function a(t){return(u||(u=!0,window.addEventListener("pagehide",()=>{l=null,r=null,i=!0})),l)?l:l=(async()=>{let e=t;window.location.pathname.startsWith("/admin")&&!window.location.pathname.startsWith("/admin-entry")&&(t.endsWith("KaRhKY16")||t.includes("KaRhKY16"))&&(e="2009034946-LkF5LngF");let n=await o();n&&(i||!n.id)&&(i&&(i=!1),await new Promise(t=>requestAnimationFrame(()=>t())),await n.init({liffId:e}))})().catch(t=>{throw l=null,t})}function c(){if(!r)return!1;try{return r.isInClient()}catch(t){return!1}}function s(){if(!r)return!1;try{return r.isLoggedIn()}catch(t){return!1}}function d(t){r&&r.login({redirectUri:t})}async function f(){var t;let e=await o();if(!e)throw Error("LIFF が利用できません");let n=await e.getProfile();return{userId:n.userId,displayName:null!==(t=n.displayName)&&void 0!==t?t:"",pictureUrl:n.pictureUrl}}async function m(){let t=await o();if(!t||"function"!=typeof t.getIDToken)return null;try{let e=await t.getIDToken();return e&&"string"==typeof e?e:null}catch(t){return null}}async function h(){let t=await o();if(!t||"function"!=typeof t.getDecodedIDToken)return null;try{let e=t.getDecodedIDToken();if((null==e?void 0:e.email)&&"string"==typeof e.email&&e.email.trim())return e.email.trim();return null}catch(t){return null}}function y(){(null==r?void 0:r.closeWindow)&&r.closeWindow()}},5173:function(t,e,n){n.d(e,{Rd:function(){return i},Ro:function(){return u},VV:function(){return o},dr:function(){return a},eg:function(){return l}});let r="marche-link-admin-storeNames";function l(t){if(!t)return"";try{let e=localStorage.getItem(r);if(!e)return"";let n=JSON.parse(e);if(!n||"object"!=typeof n)return"";let l=n[t];return"string"==typeof l?l.trim():""}catch(t){return""}}function i(t,e){if(t)try{let n=localStorage.getItem(r),l=n?JSON.parse(n):{};l[t]="string"==typeof e?e.trim():"",localStorage.setItem(r,JSON.stringify(l))}catch(t){}}let u="marche-link-storeName-updated";function o(){window.dispatchEvent(new CustomEvent(u))}function a(t){if(Array.isArray(t)&&0!==t.length)try{let e=localStorage.getItem(r);if(!e)return;let n=JSON.parse(e);if(!n||"object"!=typeof n)return;let l=!1;for(let e of t)e&&e in n&&(delete n[e],l=!0);l&&(localStorage.setItem(r,JSON.stringify(n)),window.dispatchEvent(new CustomEvent(u)))}catch(t){}}},8045:function(t,e,n){n.d(e,{J2:function(){return i},Mn:function(){return l},rZ:function(){return u}});let r="marche-link-admin-manual-logout";function l(){try{return"1"===window.localStorage.getItem(r)}catch(t){return!1}}function i(){try{window.localStorage.setItem(r,"1")}catch(t){}}function u(){try{window.localStorage.removeItem(r)}catch(t){}}}}]);