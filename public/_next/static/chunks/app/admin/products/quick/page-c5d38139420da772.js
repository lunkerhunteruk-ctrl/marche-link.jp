(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[671],{915:function(e,t,a){Promise.resolve().then(a.bind(a,2657))},2657:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return j}});var r=a(7437),l=a(2265),n=a(7648),s=a(9376),i=a(5978),o=a(3168),c=a(2268),u=a(31),d=a(3465),m=a(6942),h=a(6679),x=a(7293),g=a(316),b=a(2489),f=a(3581),p=a(3113);let y="marche-link-quick-first-after-onboarding",v="marche-link-quick-onboarding-modal-seen",w="marche-link-quick-step2-callout-seen";function j(){let e=(0,s.useSearchParams)(),t=(0,l.useRef)(null),a=(0,l.useRef)(null),j=(0,l.useRef)(null),{user:N}=(0,m.a)(),{storeIds:k,loading:C,newOrderNotificationEnabled:S}=(0,h.dD)(),[E,R]=(0,l.useState)(""),[P,F]=(0,l.useState)(!1),[I,L]=(0,l.useState)(!1),T=(0,l.useRef)(null),[U,z]=(0,l.useState)(null),[D,Z]=(0,l.useState)(null),[M,A]=(0,l.useState)(!1),[O,W]=(0,l.useState)(null),[q,H]=(0,l.useState)(""),[X,_]=(0,l.useState)(!1),[B,J]=(0,l.useState)(""),[Q,K]=(0,l.useState)(""),[$,V]=(0,l.useState)(o.HR),[G,Y]=(0,l.useState)(o.X0),[ee,et]=(0,l.useState)(o.ST),[ea,er]=(0,l.useState)(o.X0[0]),[el,en]=(0,l.useState)(o.ST[0]),[es,ei]=(0,l.useState)(null),[eo,ec]=(0,l.useState)(null),[eu,ed]=(0,l.useState)(!1),[em,eh]=(0,l.useState)(null);(0,l.useEffect)(()=>{k.length>=1&&!C?R(e=>e&&k.includes(e)?e:k[0]):0!==k.length||C||R("")},[k,C]),(0,l.useEffect)(()=>{(null!=e.get("created")||"1"===sessionStorage.getItem(y))&&"1"!==sessionStorage.getItem(v)?F(!0):"1"===sessionStorage.getItem(v)&&"1"!==sessionStorage.getItem(w)&&L(!0)},[e]),(0,l.useEffect)(()=>{if(!(null==N?void 0:N.uid))return;let e=!1;return(0,c.b)(N.uid).then(t=>{if(e)return;let a=t.productNames.length>0?t.productNames:o.HR,r=t.units.length>0?t.units:o.X0,l=t.categories.length>0?t.categories:o.ST;V(a),Y(r),et(l),er(e=>r.includes(e)?e:r[0]),en(e=>l.includes(e)?e:l[0])}),()=>{e=!0}},[null==N?void 0:N.uid]);let ex=(0,l.useCallback)(()=>{var e;null===(e=j.current)||void 0===e||e.getTracks().forEach(e=>e.stop()),j.current=null,A(!1),W(null)},[]),eg=(0,l.useCallback)(async()=>{W(null);try{let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:1280}},audio:!1});j.current=e,A(!0)}catch(e){W(e instanceof Error?e.message:"カメラを起動できませんでした"),A(!1)}},[]);(0,l.useEffect)(()=>{if(!M||!j.current)return;let e=a.current;if(e)return e.srcObject=j.current,e.play().catch(()=>{}),()=>{e.srcObject=null}},[M]);let eb=(0,l.useCallback)(()=>{let e=a.current;e&&j.current&&!(e.readyState<2)&&new Promise((t,a)=>{let r=Math.min(e.videoWidth,e.videoHeight),l=(e.videoWidth-r)/2,n=(e.videoHeight-r)/2,s=document.createElement("canvas");s.width=r,s.height=r;let i=s.getContext("2d");if(!i){a(Error("Canvas not available"));return}i.drawImage(e,l,n,r,r,0,0,r,r),s.toBlob(e=>{if(!e){a(Error("Failed to create blob"));return}t({blob:e,dataUrl:s.toDataURL("image/jpeg",.9)})},"image/jpeg",.9)}).then(e=>{let{blob:t,dataUrl:a}=e,r=new File([t],"capture.jpg",{type:"image/jpeg"});ex(),Z(r),z(a),ei(null),ec(null)},()=>W("撮影に失敗しました"))},[ex]);(0,l.useEffect)(()=>()=>{var e;null===(e=j.current)||void 0===e||e.getTracks().forEach(e=>e.stop()),j.current=null},[]);let ef=()=>{ex(),z(null),Z(null),ei(null),ec(null)},ep=async e=>{if(ec(null),D&&E.trim()){ed(!0);try{var t,a,r;let l=(null==U?void 0:U.startsWith("data:"))?U:D,n=await (0,d.R)(l),s=new FormData;s.append("image",n,"product.jpg"),s.append("subdomain",E.trim().toLowerCase());let c=await fetch("/upload-product-image.php",{method:"POST",body:s}),u=await c.json().catch(()=>({}));if(!c.ok)throw Error(u.message||"アップロード失敗 (".concat(c.status,")"));let m=null!==(t=u.url)&&void 0!==t?t:null;ei(m);let h=(0,x.T)();h&&m&&await (0,i.ET)((0,i.hJ)(h,"stores",E.trim().toLowerCase(),"products"),{title:q.trim()||"（無題）",imageUrl:m,category:el,price:parseInt(B,10)||0,stockQuantity:""===Q.trim()?0:Math.max(0,parseInt(Q,10)||0),unit:ea||"",published:!!e,createdAt:(0,i.Bt)()}),eh({message:e?"".concat(q||"（無題）"," / \xa5").concat(B||"0"," / ").concat(ea," / ").concat(el):"".concat(q||"（無題）"," / \xa5").concat(B||"0"," / ").concat(ea," / ").concat(el,"\n商品一覧で確認できます。"),published:!!e}),S&&(0,g.i)(E.trim()||null),ef(),H(""),J(""),K(""),er(null!==(a=G[0])&&void 0!==a?a:o.X0[0]),en(null!==(r=ee[0])&&void 0!==r?r:o.ST[0])}catch(t){let e=t instanceof Error?t.message:"アップロードに失敗しました";ec(e),alert("保存に失敗しました: ".concat(e))}finally{ed(!1)}}else alert(D&&!E.trim()?"写真を保存するには、ログインしてショップを登録してください。":"出品: ".concat(q||"（未入力）"," / \xa5").concat(B||"0"," / ").concat(ea," / ").concat(el))},ey=(0,l.useCallback)(()=>{if(F(!1),sessionStorage.setItem(v,"1"),sessionStorage.removeItem(y),"1"!==sessionStorage.getItem(w)&&L(!0),null!=e.get("created")){let e=new URL(window.location.href);e.searchParams.delete("created"),window.history.replaceState({},"",e.pathname+e.search)}},[e]),ev=(0,l.useCallback)(()=>{L(!1),sessionStorage.setItem(w,"1")},[]);return(0,r.jsxs)("div",{className:"flex flex-col pb-24",children:[P&&(0,r.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",role:"dialog","aria-modal":"true","aria-labelledby":"onboarding-quick-title",children:(0,r.jsxs)("div",{className:"w-full max-w-sm rounded-2xl bg-white p-5 shadow-lg",children:[(0,r.jsx)("h2",{id:"onboarding-quick-title",className:"text-center text-sm font-medium text-gray-800",children:"お店、もうできてます！ まずは1点出品して、お店の様子を確認してみよう。"}),(0,r.jsx)("button",{type:"button",onClick:ey,className:"mt-4 w-full min-h-touch rounded-xl bg-[var(--admin-accent)] py-3 text-sm font-medium text-white active:opacity-90",children:"はじめる"})]})}),(0,r.jsxs)("section",{className:"w-full shrink-0",children:[(0,r.jsxs)("div",{className:"relative w-full aspect-square max-w-md mx-auto rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 overflow-hidden",children:[(0,r.jsx)("input",{ref:t,type:"file",accept:"image/*",onChange:e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;Z(a),ei(null),ec(null);let r=new FileReader;r.onload=()=>{z(r.result)},r.readAsDataURL(a),e.target.value=""},className:"hidden","aria-hidden":!0}),U?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("img",{src:U,alt:"商品プレビュー",className:"absolute inset-0 z-0 h-full w-full object-cover object-center pointer-events-none",style:{objectPosition:"center center"}}),(0,r.jsx)("button",{type:"button",onClick:e=>{e.preventDefault(),e.stopPropagation(),ef()},className:"absolute top-2 right-2 z-20 flex min-h-touch min-w-touch items-center justify-center rounded-full bg-black/50 text-white shadow-md hover:bg-black/70 active:bg-black/70","aria-label":"写真を削除",children:(0,r.jsx)(b.Z,{className:"h-6 w-6",strokeWidth:2.5})})]}):M?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("video",{ref:a,autoPlay:!0,playsInline:!0,muted:!0,className:"absolute inset-0 z-0 h-full w-full object-cover object-center",style:{objectPosition:"center center"}}),(0,r.jsx)("div",{className:"absolute inset-x-0 bottom-0 z-20 flex justify-center pb-4",children:(0,r.jsx)("button",{type:"button",onClick:eb,className:"flex min-h-[56px] min-w-[56px] items-center justify-center rounded-full border-4 border-white bg-white/90 shadow-lg active:scale-95","aria-label":"撮影",children:(0,r.jsx)("span",{className:"h-10 w-10 rounded-full bg-gray-800"})})}),(0,r.jsx)("button",{type:"button",onClick:ex,className:"absolute top-2 right-2 z-20 flex min-h-touch min-w-touch items-center justify-center rounded-full bg-black/50 text-white","aria-label":"キャンセル",children:(0,r.jsx)(b.Z,{className:"h-6 w-6",strokeWidth:2.5})})]}):(0,r.jsxs)("div",{className:"absolute inset-0 z-0 flex items-center justify-center p-4",children:[(0,r.jsx)("button",{type:"button",onClick:eg,className:"flex min-h-touch flex-col items-center justify-center rounded-2xl border-2 border-gray-300 bg-white px-10 py-8 shadow-md active:scale-[0.98] active:bg-gray-50","aria-label":"カメラを起動",children:(0,r.jsx)(f.Z,{className:"h-16 w-16 text-gray-600","aria-hidden":!0})}),(0,r.jsx)("button",{type:"button",onClick:()=>{var e;return null===(e=t.current)||void 0===e?void 0:e.click()},className:"absolute bottom-3 right-3 flex h-12 w-12 items-center justify-center rounded-xl border border-gray-200 bg-white/90 shadow active:bg-gray-100","aria-label":"アルバムから選択",children:(0,r.jsx)(p.Z,{className:"h-6 w-6 text-gray-500","aria-hidden":!0})})]})]}),O&&(0,r.jsx)("p",{className:"mt-1 text-sm text-amber-700",role:"alert",children:O}),eo&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",role:"alert",children:eo})]}),!C&&!N&&(0,r.jsx)("p",{className:"mt-4 text-base text-gray-600",children:"ログインすると紐づいているショップに保存できます。"}),!C&&N&&0===k.length&&(0,r.jsxs)("p",{className:"mt-4 text-base text-gray-600",children:["ショップがありません。",(0,r.jsx)(n.default,{href:"/admin/register",className:"text-[var(--admin-accent)] underline ml-1",children:"新規ショップ登録"}),"を完了すると保存できます。"]}),(0,r.jsxs)("section",{className:"mt-6",ref:T,children:[(0,r.jsx)("label",{htmlFor:"product-name",className:"mb-2 block text-base font-medium text-gray-800",children:"商品名"}),(0,r.jsxs)("div",{className:"relative",children:[I&&(0,r.jsxs)("div",{className:"absolute z-20 left-0 right-0 bottom-full mb-2",role:"dialog","aria-live":"polite","aria-label":"案内",children:[(0,r.jsxs)("div",{className:"rounded-xl border border-gray-200 bg-white px-4 py-3 shadow-lg",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-800",children:"ここに商品名を入れて、1点出品してみよう。"}),(0,r.jsx)("div",{className:"mt-3 flex justify-end",children:(0,r.jsx)("button",{type:"button",onClick:ev,className:"min-h-touch rounded-full bg-[var(--admin-accent)] px-4 py-2 text-sm font-medium text-white shadow-sm active:opacity-90","aria-label":"閉じる",children:"OK"})})]}),(0,r.jsx)("div",{className:"absolute left-6 top-full w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-white","aria-hidden":!0})]}),X&&(0,r.jsx)("ul",{className:"absolute z-10 bottom-full left-0 right-0 mb-1 max-h-48 w-full overflow-auto rounded-lg border border-gray-200 bg-white py-1 shadow-lg",role:"listbox",children:$.filter(e=>e.toLowerCase().includes(q.toLowerCase())).map(e=>(0,r.jsx)("li",{children:(0,r.jsx)("button",{type:"button",className:"w-full px-3 py-2 text-left text-base hover:bg-gray-100",onMouseDown:t=>{t.preventDefault(),H(e),_(!1)},role:"option",children:e})},e))}),(0,r.jsx)("input",{id:"product-name",type:"text",inputMode:"text",lang:"ja",value:q,onChange:e=>H(e.target.value),onFocus:()=>_(!0),onBlur:()=>setTimeout(()=>_(!1),150),placeholder:$[0]?"例: ".concat($[0]):"例: 商品名",className:"w-full rounded-xl border border-gray-300 px-4 py-4 text-lg",autoComplete:"off"})]})]}),(0,r.jsxs)("section",{className:"mt-6 grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"price",className:"mb-2 block text-base font-medium text-gray-800",children:"価格（円）"}),(0,r.jsx)("input",{id:"price",type:"text",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"off",value:B,onChange:e=>J(e.target.value.replace(/\D/g,"")),placeholder:"0",className:"w-full rounded-xl border border-gray-300 px-4 py-4 text-xl"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"stockQuantity",className:"mb-2 block text-base font-medium text-gray-800",children:"在庫数量"}),(0,r.jsx)("input",{id:"stockQuantity",type:"text",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"off",value:Q,onChange:e=>K(e.target.value.replace(/\D/g,"")),placeholder:"0",className:"w-full rounded-xl border border-gray-300 px-4 py-4 text-xl"})]})]}),(0,r.jsxs)("section",{className:"mt-6 grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"unit",className:"mb-2 block text-base font-medium text-gray-800",children:"単位"}),(0,r.jsx)("select",{id:"unit",value:ea,onChange:e=>er(e.target.value),className:"w-full rounded-xl border border-gray-300 px-4 py-4 text-lg",children:G.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"category",className:"mb-2 block text-base font-medium text-gray-800",children:"カテゴリ"}),(0,r.jsx)("select",{id:"category",value:el,onChange:e=>en(e.target.value),className:"w-full rounded-xl border border-gray-300 px-4 py-4 text-lg",children:ee.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]})]}),(0,r.jsxs)("section",{className:"mt-6 space-y-2",children:[(0,r.jsx)("button",{type:"button",disabled:eu,className:"flex min-h-touch w-full items-center justify-center rounded-xl bg-[var(--admin-accent)] py-4 text-lg font-semibold text-white active:opacity-90 disabled:opacity-50",onClick:()=>ep(!0),children:eu?"保存中…":"出品する"}),(0,r.jsx)("button",{type:"button",disabled:eu,className:"flex min-h-touch w-full items-center justify-center rounded-xl border-2 border-[var(--admin-accent)] bg-white py-3 text-base font-medium text-[var(--admin-accent)] active:bg-gray-50 disabled:opacity-50",onClick:()=>ep(!1),children:"下書きに保存"})]}),em&&(0,r.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",role:"dialog","aria-modal":"true","aria-labelledby":"success-modal-title",children:(0,r.jsxs)("div",{className:"w-full max-w-sm rounded-2xl bg-white p-6 shadow-lg relative z-10",children:[(0,r.jsx)("h2",{id:"success-modal-title",className:"text-center text-xl font-semibold text-gray-900",children:em.published?"出品しました":"下書きに保存しました"}),(0,r.jsx)("p",{className:"mt-4 whitespace-pre-line text-2xl font-semibold text-gray-800",children:em.message}),em.published&&E&&(0,r.jsx)("a",{href:"".concat(u.Dj,"?shop=").concat(encodeURIComponent(E.trim().toLowerCase())),target:"_blank",rel:"noopener noreferrer",className:"mt-4 flex min-h-touch w-full items-center justify-center rounded-xl bg-[var(--admin-accent)] py-4 text-lg font-medium text-white active:opacity-90",children:"商品を自分のストアで見る"}),(0,r.jsx)("button",{type:"button",onClick:()=>eh(null),className:"mt-3 flex min-h-touch w-full items-center justify-center rounded-xl border-2 border-[var(--admin-accent)] bg-white py-4 text-lg font-medium text-[var(--admin-accent)] active:bg-gray-50 ".concat(em.published&&E?"":"mt-6"),children:"OK"})]})})]})}},3168:function(e,t,a){"use strict";a.d(t,{HR:function(){return r},ST:function(){return n},X0:function(){return l}});let r=["クロワッサン","メロンパン","アップルパイ","食パン","カレーパン","惣菜パン","飲み物"],l=["個","本","束","ケース","箱","袋","パック"],n=["パン","飲み物","惣菜","その他"]},2268:function(e,t,a){"use strict";a.d(t,{b:function(){return o},x:function(){return c}});var r=a(5978),l=a(7293),n=a(3168);let s={productNames:[...n.HR],units:[...n.X0],categories:[...n.ST]};function i(e){return Array.isArray(e)&&e.every(e=>"string"==typeof e)}async function o(e){let t=(0,l.T)();if(!t)return s;let a=await (0,r.QT)((0,r.JU)(t,"adminUsers",e));if(!a.exists())return s;let n=a.data();return{productNames:i(null==n?void 0:n.presetProductNames)?n.presetProductNames:s.productNames,units:i(null==n?void 0:n.presetUnits)?n.presetUnits:s.units,categories:i(null==n?void 0:n.presetCategories)?n.presetCategories:s.categories}}async function c(e,t){let a=(0,l.T)();a&&await (0,r.pl)((0,r.JU)(a,"adminUsers",e),{presetProductNames:t.productNames,presetUnits:t.units,presetCategories:t.categories},{merge:!0})}},316:function(e,t,a){"use strict";a.d(t,{S:function(){return n},i:function(){return s}});var r=a(5978),l=a(7293);let n="marche-link:new-orders";async function s(e){let t=(0,l.T)(),a=null==e?void 0:e.trim().toLowerCase();if(t&&a)try{let e=(0,r.IO)((0,r.hJ)(t,"stores",a,"orders"),(0,r.ar)("status","==","unpaid"),(0,r.b9)(100)),l=(await (0,r.PL)(e)).size;l>0&&window.dispatchEvent(new CustomEvent(n,{detail:{count:l}}))}catch(e){}}},3465:function(e,t,a){"use strict";function r(e){return new Promise((t,a)=>{let r="string"==typeof e&&e.startsWith("data:"),l=e=>{let r=new Image;r.onload=()=>{let e=document.createElement("canvas");e.width=1e3,e.height=1e3;let l=e.getContext("2d");if(!l){a(Error("Canvas context not available"));return}let n=Math.max(1e3/r.width,1e3/r.height),s=r.width,i=r.height;l.drawImage(r,(s-1e3/n)/2,(i-1e3/n)/2,1e3/n,1e3/n,0,0,1e3,1e3),e.toBlob(e=>{e?t(e):a(Error("Failed to create blob"))},"image/jpeg",.9)},r.onerror=()=>a(Error("Failed to load image")),r.src=e};r?l(e):new Promise((t,a)=>{let r=new FileReader;r.onload=()=>{let e=r.result;"string"==typeof e&&e.startsWith("data:")?t(e):a(Error("Failed to read file as data URL"))},r.onerror=()=>a(Error("Failed to load image")),r.readAsDataURL(e)}).then(l).catch(a)})}a.d(t,{R:function(){return r}})},9205:function(e,t,a){"use strict";a.d(t,{Z:function(){return o}});var r=a(2265);let l=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return t.filter((e,t,a)=>!!e&&""!==e.trim()&&a.indexOf(e)===t).join(" ").trim()};var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,r.forwardRef)((e,t)=>{let{color:a="currentColor",size:l=24,strokeWidth:i=2,absoluteStrokeWidth:o,className:c="",children:u,iconNode:d,...m}=e;return(0,r.createElement)("svg",{ref:t,...s,width:l,height:l,stroke:a,strokeWidth:o?24*Number(i)/Number(l):i,className:n("lucide",c),...m},[...d.map(e=>{let[t,a]=e;return(0,r.createElement)(t,a)}),...Array.isArray(u)?u:[u]])}),o=(e,t)=>{let a=(0,r.forwardRef)((a,s)=>{let{className:o,...c}=a;return(0,r.createElement)(i,{ref:s,iconNode:t,className:n("lucide-".concat(l(e)),o),...c})});return a.displayName="".concat(e),a}},3581:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]])},3113:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]])},2489:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},9376:function(e,t,a){"use strict";var r=a(5475);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[358,990,249,648,679,971,117,744],function(){return e(e.s=915)}),_N_E=e.O()}]);