(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[680],{280:function(e,t,a){Promise.resolve().then(a.bind(a,4962))},4962:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return b}});var n=a(7437),r=a(2265),l=a(7648),i=a(9376),s=a(5978),o=a(6942),c=a(7293),d=a(6679),u=a(3582),m=a(6363),f=a(31),p=a(2498),h=a(6515),x=a(8045);function b(){let e=(0,i.useRouter)(),{user:t,loading:a,signInWithLine:b}=(0,o.a)(),{refetch:y}=(0,d.dD)(),[v,g]=(0,r.useState)(""),[j,N]=(0,r.useState)(!1),[C,E]=(0,r.useState)(null),[w,k]=(0,r.useState)(!1),[S,I]=(0,r.useState)(!1),[P,T]=(0,r.useState)(!1),[U,F]=(0,r.useState)(null),A=(0,r.useRef)(!1),D=(0,r.useCallback)(()=>{if(!(null==t?void 0:t.uid))return;let a=(0,d.fX)(t.uid);if(null!==a&&a.length>=1){e.replace("/admin");return}let n=(0,c.T)();n&&(0,s.QT)((0,s.JU)(n,"adminUsers",t.uid)).then(t=>{var a;(t.exists()&&Array.isArray(null===(a=t.data())||void 0===a?void 0:a.storeIds)?t.data().storeIds:[]).length>=1&&e.replace("/admin")}).catch(()=>{})},[null==t?void 0:t.uid,e]);if((0,r.useEffect)(()=>{let e=!1,t=setTimeout(()=>{e||I(!0)},4e3);return(0,h.$w)(f.p3).then(()=>{e||I(!0)}),()=>{e=!0,clearTimeout(t)}},[]),(0,r.useEffect)(()=>{!(!S||a||(null==t?void 0:t.uid)||!(0,h.DT)()||(0,x.Mn)())&&(A.current||(A.current=!0,T(!0),F(null),b().then(()=>{}).catch(e=>{A.current=!1,F(e instanceof Error?e.message:"LINE 認証に失敗しました。")}).finally(()=>T(!1))))},[S,a,null==t?void 0:t.uid,b]),(0,r.useEffect)(()=>{if(a)return;if(!(null==t?void 0:t.uid)){k(!0);return}let n=(0,d.fX)(t.uid);if(null!==n&&n.length>=1){e.replace("/admin");return}let r=(0,c.T)();if(!r){k(!0);return}let l=!1;return(0,s.QT)((0,s.JU)(r,"adminUsers",t.uid)).then(t=>{var a;l||((t.exists()&&Array.isArray(null===(a=t.data())||void 0===a?void 0:a.storeIds)?t.data().storeIds:[]).length>=1&&e.replace("/admin"),k(!0))}).catch(()=>{l||k(!0)}),()=>{l=!0}},[null==t?void 0:t.uid,a,e]),(0,r.useEffect)(()=>{if(!(null==t?void 0:t.uid))return;let e=()=>{"visible"===document.visibilityState&&D()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[null==t?void 0:t.uid,D]),!S)return(0,n.jsx)("main",{className:"max-w-2xl mx-auto p-6",children:(0,n.jsx)("p",{className:"text-gray-600",children:"読み込み中..."})});if(!(0,h.DT)())return(0,n.jsxs)("main",{className:"max-w-2xl mx-auto p-6",children:[(0,n.jsx)("div",{className:"mb-4",children:(0,n.jsx)(l.default,{href:"/admin",className:"min-h-touch text-sm text-[var(--admin-accent)] underline",children:"← 管理画面へ"})}),(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-200 bg-amber-50 p-6 text-center",children:[(0,n.jsx)("p",{className:"font-medium text-amber-900",children:"管理画面は LINE アプリ内で開いてください"}),(0,n.jsx)("p",{className:"mt-2 text-sm text-amber-800",children:"このページは LINE アプリから開くと、ログインなしでご利用いただけます。"})]})]});if(!(null==t?void 0:t.uid)){let e=(0,x.Mn)();return(0,n.jsxs)("main",{className:"max-w-2xl mx-auto p-6",children:[(0,n.jsx)("div",{className:"mb-4",children:(0,n.jsx)(l.default,{href:"/admin",className:"min-h-touch text-sm text-[var(--admin-accent)] underline",children:"← 管理画面へ"})}),e?(0,n.jsxs)("div",{className:"space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm",children:[(0,n.jsx)("p",{className:"text-gray-700",children:"ログアウトしました。再度ログインするには下のボタンを押してください。"}),U&&(0,n.jsx)("p",{className:"text-sm text-red-600",role:"alert",children:U}),(0,n.jsx)("button",{type:"button",onClick:()=>{T(!0),F(null);let e=Date.now();b().then(()=>{}).catch(e=>{F(e instanceof Error?e.message:"LINE 認証に失敗しました。")}).finally(()=>{let t=Math.max(0,600-(Date.now()-e));t>0?setTimeout(()=>T(!1),t):T(!1)})},disabled:P,className:"min-h-touch w-full rounded-xl bg-[var(--admin-accent)] px-4 py-3 text-base font-medium text-white disabled:opacity-50 active:opacity-90",children:P?"ログイン中…":"ログイン"})]}):P?(0,n.jsx)("p",{className:"text-gray-600",children:"LINE で認証しています..."}):U?(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsx)("p",{className:"text-sm text-red-600",role:"alert",children:U}),(0,n.jsx)("button",{type:"button",onClick:()=>window.location.reload(),className:"min-h-touch rounded-xl bg-[var(--admin-accent)] px-4 py-3 text-sm font-medium text-white",children:"再試行"})]}):(0,n.jsx)("p",{className:"text-gray-600",children:"認証を準備しています..."})]})}return t&&!w?(0,n.jsx)("main",{className:"max-w-2xl mx-auto p-6",children:(0,n.jsx)("p",{className:"text-gray-600",children:"登録状態を確認しています..."})}):(0,n.jsxs)("main",{className:"max-w-2xl mx-auto p-6",children:[(0,n.jsx)("div",{className:"mb-4",children:(0,n.jsx)(l.default,{href:"/admin",className:"min-h-touch text-sm text-[var(--admin-accent)] underline",children:"← 管理画面へ"})}),(0,n.jsxs)("div",{className:"mb-8 rounded-2xl border border-gray-200 bg-gray-50 p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)]",children:[(0,n.jsx)("p",{className:"text-sm font-medium text-gray-800 mb-3",children:"登録済みの方はこちら"}),(0,n.jsx)("button",{type:"button",onClick:D,className:"min-h-touch w-full rounded-xl border border-[var(--admin-accent)]/30 bg-[var(--admin-accent)]/10 px-4 py-3 text-sm font-medium text-[var(--admin-accent)] hover:bg-[var(--admin-accent)]/20 active:scale-[0.99]",children:"登録状態を確認して管理画面へ"})]}),(0,n.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"新規ショップ登録"}),(0,n.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"ショップ名を入力して作成すると、URL（例: marche-link.jp/hidamari）とデザインが自動で決まります。あとから設定で変更できます。"}),C&&(0,n.jsx)("p",{className:"text-sm text-red-600 mb-4",role:"alert",children:C}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("label",{className:"block",children:[(0,n.jsxs)("span",{className:"block text-sm font-medium text-gray-700 mb-1",children:["ショップ名 ",(0,n.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,n.jsx)("input",{type:"text",value:v,onChange:e=>g(e.target.value),placeholder:"例: 陽だまりパン工房",className:"w-full border border-gray-300 rounded-xl px-4 py-3 text-base",autoComplete:"organization",disabled:j})]}),(0,n.jsx)("button",{type:"button",onClick:()=>{let t=v.trim();if(!t){E("ショップ名を入力してください。");return}N(!0),E(null),(0,u.W)(t).then(async a=>{let{storeId:n,buttonColor:r}=a;try{let e=await (0,m.$)(t,r),a=new FormData;a.append("image",e,"icon.jpg"),a.append("subdomain",n);let l=p.E.baseUrl,i=await fetch("".concat(l,"/upload-shop-icon.php"),{method:"POST",body:a}),o=await i.json().catch(()=>({}));if(i.ok&&o.success&&"string"==typeof o.url){let e=(0,c.T)();if(e){let t=o.url.startsWith("http")?o.url:"".concat(l).concat(o.url);await (0,s.r7)((0,s.JU)(e,"stores",n),{iconUrl:t,updatedAt:(0,s.Bt)()})}}}catch(e){}await y(),e.replace("/admin/products/quick?created=".concat(n))}).catch(e=>{E(e instanceof Error?e.message:"ショップの作成に失敗しました。")}).finally(()=>N(!1))},disabled:j||!v.trim(),className:"min-h-touch w-full rounded-xl bg-[var(--admin-accent)] px-4 py-3 text-base font-medium text-white disabled:opacity-50 active:opacity-90",children:j?"作成中…":"ストアを作成"})]}),(0,n.jsx)("p",{className:"mt-4 text-xs text-gray-500",children:"作成後、商品登録画面に移動します。ショップのコンセプトやデザインの調整は「設定 → ショップのデザイン」で行えます。"})]})}},2498:function(e,t,a){"use strict";a.d(t,{E:function(){return n}});let n={siteName:"マルシェリンク",baseUrl:"https://marche-link.jp",ogImageUrl:"https://marche-link.jp/admin-ogp.png",ogImageWidth:1200,ogImageHeight:630,ogTitle:"ストア管理画面 | マルシェリンク",defaultDescription:"注文・商品・QRコードを、いつものLINEでまとめて管理。"}},3582:function(e,t,a){"use strict";a.d(t,{W:function(){return i}});var n=a(7293),r=a(6514);function l(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}async function i(e){if(!(0,n.G5)())throw Error("Firebase が利用できません");let t=(0,n.lx)("asia-northeast1");if(!t)throw Error("Cloud Functions が利用できません");let a=(0,n.V1)(t,"createStoreWithAdminSimple"),i=(await a({name:e.trim()})).data,s=null==i?void 0:i.buttonColor;if((null==i?void 0:i.storeId)&&(!s||!l(s)))try{var o,c,d;let e=await (0,r.M)(i.storeId),t=null!==(d=null===(o=e.theme)||void 0===o?void 0:o.buttonColor)&&void 0!==d?d:null===(c=e.theme)||void 0===c?void 0:c.primaryColor;t&&l(t)&&(s=t)}catch(e){s=null}return{storeId:i.storeId,buttonColor:null!=s?s:null}}},6514:function(e,t,a){"use strict";a.d(t,{M:function(){return s}});var n=a(5978),r=a(7293),l=a(4770);function i(e){if("string"!=typeof e)return null;let t=e.trim();if(/^#[0-9A-Fa-f]{6}$/.test(t))return t;if(/^#[0-9A-Fa-f]{3}$/.test(t)){let e=t[1]+t[1],a=t[2]+t[2],n=t[3]+t[3];return"#".concat(e).concat(a).concat(n)}return null}async function s(e){let t=(0,r.T)(),a=e.trim().toLowerCase();if(!t||!a)return{name:a||"ショップ",theme:l.t,description:void 0,payment:{paypayEnabled:!1,paypaySuffix:"",cashEnabled:!1,bankEnabled:!1,bankDetails:"",customMethods:[]}};let s=await (0,n.QT)((0,n.JU)(t,"stores",a));if(!s.exists())return{name:a,theme:l.t,description:void 0,payment:{paypayEnabled:!1,paypaySuffix:"",cashEnabled:!1,bankEnabled:!1,bankDetails:"",customMethods:[]}};let o=s.data(),c="string"==typeof(null==o?void 0:o.name)&&o.name.trim()?o.name.trim():a,d="string"==typeof(null==o?void 0:o.iconUrl)&&o.iconUrl.trim()?o.iconUrl.trim():null,u="string"==typeof(null==o?void 0:o.description)&&o.description.trim()?o.description.trim():null,m=function(e){var t,a,n,r,s,o,c,d;if(!e||"object"!=typeof e)return l.t;let u=e.theme;if(!u||"object"!=typeof u)return l.t;let m=null!==(a=i(null!==(t=u.primaryColor)&&void 0!==t?t:u.buttonColor))&&void 0!==a?a:l.t.primaryColor,f=null!==(r=i(null!==(n=u.buttonColor)&&void 0!==n?n:u.primaryColor))&&void 0!==r?r:m,p=null!==(o=i(null!==(s=u.headerColor)&&void 0!==s?s:u.primaryColor))&&void 0!==o?o:m;return{primaryColor:m,buttonColor:f,headerColor:p,backgroundColor:null!==(c=i(u.backgroundColor))&&void 0!==c?c:l.t.backgroundColor,textColor:null!==(d=i(u.textColor))&&void 0!==d?d:l.t.textColor,fontFamily:"string"==typeof u.fontFamily&&/^(sans-serif|serif|monospace)$/.test(u.fontFamily)?u.fontFamily:l.t.fontFamily}}(o),f=null==o?void 0:o.paymentCustomMethods,p=[];if(Array.isArray(f))for(let e of f)e&&"object"==typeof e&&"string"==typeof e.label?e.label.trim()&&!0===e.enabled&&p.push(e.label.trim()):"string"==typeof e&&e.trim()&&p.push(e.trim());return{name:c,iconUrl:null!=d?d:void 0,description:null!=u?u:void 0,theme:m,payment:{paypayEnabled:(null==o?void 0:o.paymentPayPayEnabled)===!0,paypaySuffix:"string"==typeof(null==o?void 0:o.paymentPayPaySuffix)?o.paymentPayPaySuffix.trim():"",cashEnabled:(null==o?void 0:o.paymentCashEnabled)!==!1,bankEnabled:(null==o?void 0:o.paymentBankEnabled)===!0,bankDetails:"string"==typeof(null==o?void 0:o.paymentBankDetails)?o.paymentBankDetails.trim():"",customMethods:p}}}},4770:function(e,t,a){"use strict";a.d(t,{W:function(){return r},t:function(){return n}});let n={primaryColor:"#6b7280",buttonColor:"#6b7280",headerColor:"#4b5563",backgroundColor:"#f9fafb",textColor:"#111827",fontFamily:"sans-serif"},r="https://pay.paypay.ne.jp/"},6363:function(e,t,a){"use strict";function n(e,t){let a=t&&/^#[0-9A-Fa-f]{6}$/.test(t)?t:"#4a7c59";return new Promise((t,n)=>{let r=document.createElement("canvas");r.width=300,r.height=300;let l=r.getContext("2d");if(!l){n(Error("Canvas not available"));return}let i=(e.trim().slice(0,1)||"?").toUpperCase();l.fillStyle=a,l.beginPath(),l.arc(150,150,148,0,2*Math.PI),l.fill(),l.fillStyle="#ffffff",l.font="bold ".concat(Math.floor(135),"px sans-serif"),l.textAlign="center",l.textBaseline="middle",l.fillText(i,150,150),r.toBlob(e=>{e?t(e):n(Error("Failed to create icon blob"))},"image/jpeg",.9)})}a.d(t,{$:function(){return n}})},9376:function(e,t,a){"use strict";var n=a(5475);a.o(n,"usePathname")&&a.d(t,{usePathname:function(){return n.usePathname}}),a.o(n,"useRouter")&&a.d(t,{useRouter:function(){return n.useRouter}}),a.o(n,"useSearchParams")&&a.d(t,{useSearchParams:function(){return n.useSearchParams}})}},function(e){e.O(0,[358,990,249,648,679,971,117,744],function(){return e(e.s=280)}),_N_E=e.O()}]);